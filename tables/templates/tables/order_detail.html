{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido - Mesa {{ table.number }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="light-theme"> 
    
    <div style="padding: 20px 0 0 30px; max-width: 1200px; margin: 0 auto;">
         <a href="{% url 'index' %}" style="text-decoration: none; color: var(--primary-blue); font-weight: bold;">
            <i class="fas fa-arrow-left"></i> Volver a Mesas
         </a>
         <h2 style="margin-top: 10px; color: var(--primary-blue);">Editando Mesa {{ table.number }}</h2>
    </div>

    <div class="pos-container">
        <div class="top-actions-bar">
            <button class="action-btn" onclick="abrirModalMeseros()">
                <i class="fas fa-user"></i> Seleccionar Mesero
            </button>
            
            <button class="action-btn" onclick="grabarMesa()">
                <i class="fas fa-save"></i> Grabar Mesa
            </button>
            
            <button class="action-btn"><i class="fas fa-edit"></i> Editar Mesa</button>

            <button class="action-btn" onclick="eliminarMesa()">
                <i class="fas fa-trash"></i> Eliminar Mesa
            </button>

            <button class="action-btn" onclick="pedirCuenta()">
                <i class="fas fa-credit-card"></i> Cuenta Mesa
            </button>
            <button class="action-btn" onclick="iniciarFacturacion()">
                <i class="fas fa-receipt"></i> Facturar Mesa
            </button>
        </div>

        <div class="main-pos-grid">
            
            <div class="left-panel product-selection-area card-style">
                <h3 class="panel-title">Seleccione producto</h3>
                
                <div class="search-bar-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="buscador-productos" class="search-input" placeholder="Buscar producto..." onkeyup="filtrarPorTexto()">
                </div>
                
                <div class="categories-container card-style-inner" style="overflow-x: auto; white-space: nowrap; padding-bottom: 5px; margin-bottom: 10px;">
                    <button class="category-btn active" onclick="resetearFiltros(this)">TODOS</button>
                    <button class="category-btn" onclick="filtrarPorTamano('IND', this)">IND</button>
                    <button class="category-btn" onclick="filtrarPorTamano('MED', this)">MED</button>
                    <button class="category-btn" onclick="filtrarPorTamano('FAM', this)">FAM</button>
                </div>

                <div id="grid-productos" style="display: grid; grid-template-columns: repeat(auto-fill, 110px); grid-auto-rows: 110px; gap: 10px; margin-top: 15px; overflow-y: auto; height: 350px; padding-right: 5px; align-content: start;">
                    {% for prod in productos %}
                        <div class="producto-card card-style" 
                            data-cat-id="{{ prod.categoria.id }}" 
                            data-tamano="{{ prod.tamano }}"  
                            data-nombre="{{ prod.nombre|lower }}"
                            style="cursor: pointer; padding: 5px; text-align: center; border: 1px solid #ddd; transition: transform 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;"
                            onclick="agregarAlCarrito('{{ prod.id }}', '{{ prod.nombre }}', '{{ prod.precio }}', '{{ prod.tamano }}')">
                            
                            <div style="font-weight: bold; font-size: 0.85em; margin-bottom: 5px; line-height: 1.2;">
                                {{ prod.nombre }}
                            </div>
                            {% if prod.tamano != 'UNI' %}
                                <div style="font-size: 0.7em; background: #eee; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px;">
                                    {{ prod.tamano }}
                                </div>
                            {% endif %}
                            <div style="color: var(--primary-blue); font-weight: bold; font-size: 0.9em;">
                                ${{ prod.precio }}
                            </div>
                        </div>
                    {% empty %}
                        <p style="grid-column: 1/-1; text-align: center; color: #888;">No hay productos.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="right-panel cart-area">
                <div class="info-inputs">
                    <div class="input-group">
                        <input type="text" value="TASA: {{ tasa_cambio|default:'Cargando...' }}" readonly class="readonly-field" style="background-color: #e9ecef; color: #495057; font-weight: bold;">
                    </div>
                    <div class="input-group">
                        <input type="text" id="fecha-hora-live" readonly class="readonly-field">
                    </div>
                    <div class="input-group">
                        <input type="text" id="input-mesero" placeholder="Sin mesero" value="{{ table.mesero.username|default:'' }}" readonly class="readonly-field" style="background-color: #e9ecef; color: #495057; font-weight: bold;">
                    </div>
                </div>

                <div class="cart-summary card-style">
                    <div class="cart-header">
                        <span>ITEM</span>
                        <span>CANT</span>
                        <span>PRECIO</span>
                    </div>
                    <div class="cart-items-list">
                        <p style="text-align: center; color: #aaa; padding-top: 50px;">Carrito vac√≠o</p>
                    </div>
                    <div class="cart-footer" style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; border-top: 2px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.8em; color: #666; font-weight: bold;">TOTAL $</div>
                            <div class="total-amount" id="total-usd" style="font-size: 1.5em; color: var(--primary-blue);">0.00</div>
                        </div>
                        <div style="border-left: 1px solid #ccc; margin: 0 10px;"></div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.8em; color: #666; font-weight: bold;">TOTAL Bs</div>
                            <div class="total-amount" id="total-bs" style="font-size: 1.5em; color: #28a745;">0,00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-meseros" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:10px; width:300px; text-align:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="color:var(--primary-blue); margin-bottom:15px;">Seleccionar Mesero</h3>
            <div style="display:grid; gap:10px; max-height:300px; overflow-y:auto;">
                {% for mesero in meseros %}
                <button onclick="seleccionarMesero('{{ mesero.id }}', '{{ mesero.username }}')" style="padding:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:5px; cursor:pointer; font-size:16px;">
                    <i class="fas fa-user-tie"></i> {{ mesero.username|title }}
                </button>
                {% endfor %}
            </div>
            <button onclick="cerrarModalMeseros()" style="margin-top:15px; background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN INICIAL ---
        const TASA_CAMBIO = parseFloat("{{ tasa_valor|stringformat:'f' }}");
        // Recuperamos el carrito guardado (si existe)
        let carrito = {{ carrito_json|safe|default:"[]" }};

        // Al cargar la p√°gina, dibujamos lo que hab√≠a
        document.addEventListener("DOMContentLoaded", function() {
            renderizarCarrito();
            actualizarReloj();
        });

        // --- FUNCI√ìN IMPORTANTE: GRABAR MESA ---
        function grabarMesa() {
            // 1. VALIDACI√ìN: Carrito Vac√≠o
            if (carrito.length === 0) {
                Swal.fire('Mesa Vac√≠a', 'Agrega productos antes de grabar.', 'warning');
                return;
            }

            // 2. NUEVA VALIDACI√ìN: Mesero Obligatorio
            const meseroNombre = document.getElementById('input-mesero').value;

            if (!meseroNombre || meseroNombre.trim() === "") {
                Swal.fire({
                    title: 'Falta Mesero',
                    text: '‚ö†Ô∏è No puedes grabar la mesa sin asignar un mesero responsable.',
                    icon: 'warning',
                    confirmButtonText: 'Seleccionar Mesero Ahora',
                    confirmButtonColor: '#3085d6'
                }).then((result) => {
                    if (result.isConfirmed) {
                        abrirModalMeseros(); // Le abrimos el modal autom√°ticamente para ayudarle
                    }
                });
                return; // DETIENE LA EJECUCI√ìN AQU√ç
            }

            // 3. Si pas√≥ las validaciones, preparamos los datos
            const data = {
                carrito: carrito,
                mesero: meseroNombre
            };

            // 4. Petici√≥n al servidor
            fetch("{% url 'grabar_mesa' table.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if(result.status === 'ok') {
                    Swal.fire({
                        title: '¬°Mesa Guardada!',
                        text: 'La orden se ha registrado correctamente.',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'üñ®Ô∏è Imprimir Ticket',
                        cancelButtonText: 'Seguir Editando'
                    }).then((alertResult) => {
                        if (alertResult.isConfirmed) {
                            // 1. Abrir el PDF en una pesta√±a nueva
                            const urlPDF = `/orden/${result.orden_id}/pdf/`; 
                            window.open(urlPDF, '_blank');

                            // 2. Redirigir al Dashboard de Mesas en la pesta√±a actual
                            // Usamos un peque√±o retraso (500ms) para que la transici√≥n sea suave
                            setTimeout(() => {
                                window.location.href = "{% url 'index' %}";
                            }, 500);
                        }
                    });
                } else {
                    Swal.fire('Error', 'El servidor respondi√≥: ' + result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error T√©cnico', 'No se pudo conectar con el servidor.', 'error');
            });
        }

        // --- FUNCIONES DEL CARRITO ---
        function agregarAlCarrito(id, nombre, precio, tamano) {
            let precioFloat = parseFloat(precio);
            let nombreDisplay = nombre;
            if(tamano !== 'UNI') nombreDisplay += ` (${tamano})`;
            
            // Buscar si ya existe para sumar cantidad
            let existente = carrito.find(item => item.id == id && item.nombre == nombreDisplay);
            
            if (existente) {
                existente.cantidad++;
            } else {
                carrito.push({
                    id: id,
                    nombre: nombreDisplay,
                    precio: precioFloat,
                    cantidad: 1
                });
            }
            renderizarCarrito();
        }

        function renderizarCarrito() {
            const contenedor = document.querySelector('.cart-items-list');
            const totalUsdEl = document.getElementById('total-usd');
            const totalBsEl = document.getElementById('total-bs');
            
            contenedor.innerHTML = '';
            let sumaUsd = 0;

            carrito.forEach((item, index) => {
                sumaUsd += item.precio * item.cantidad;
                
                const fila = document.createElement('div');
                fila.style.cssText = "display: grid; grid-template-columns: 2fr 1fr 1fr 30px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; align-items: center;";
                
                fila.innerHTML = `
                    <span>${item.nombre}</span>
                    <span style="text-align: center;">x${item.cantidad}</span>
                    <span style="text-align: right;">$${(item.precio * item.cantidad).toFixed(2)}</span>
                    <button onclick="eliminarDelCarrito(${index})" style="background:none; border:none; color:red; cursor:pointer; margin-left:5px;">&times;</button>
                `;
                contenedor.appendChild(fila);
            });

            let sumaBs = sumaUsd * TASA_CAMBIO;
            totalUsdEl.innerText = sumaUsd.toFixed(2);
            totalBsEl.innerText = sumaBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            if(carrito.length === 0) {
                contenedor.innerHTML = '<p style="text-align: center; color: #aaa; padding-top: 50px;">Carrito vac√≠o</p>';
            }
        }

        function eliminarDelCarrito(index) {
            carrito.splice(index, 1);
            renderizarCarrito();
        }

        // --- RELOJ Y MESEROS (C√≥digo existente) ---
        function abrirModalMeseros() { document.getElementById('modal-meseros').style.display = 'flex'; }
        function cerrarModalMeseros() { document.getElementById('modal-meseros').style.display = 'none'; }
        
        function seleccionarMesero(userId, userName) {
            fetch("{% url 'asignar_mesero' table.id %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'ok') {
                    document.getElementById('input-mesero').value = userName;
                    cerrarModalMeseros();
                }
            });
        }

        function actualizarReloj() {
            const ahora = new Date();
            const dosDigitos = (n) => n.toString().padStart(2, '0');
            const str = `${dosDigitos(ahora.getDate())}/${dosDigitos(ahora.getMonth()+1)}/${ahora.getFullYear()} ${dosDigitos(ahora.getHours())}:${dosDigitos(ahora.getMinutes())}`;
            const el = document.getElementById('fecha-hora-live');
            if(el) el.value = str;
        }

        // --- FILTROS (C√≥digo existente) ---
        let filtroCategoriaActivo = 'todas';
        let filtroTamanoActivo = 'todos';

        function actualizarVisibilidad() {
            document.querySelectorAll('.producto-card').forEach(prod => {
                const pCat = prod.getAttribute('data-cat-id');
                const pTam = prod.getAttribute('data-tamano');
                const okCat = (filtroCategoriaActivo === 'todas') || (pCat === filtroCategoriaActivo);
                const okTam = (filtroTamanoActivo === 'todos') || (pTam === filtroTamanoActivo);
                prod.style.display = (okCat && okTam) ? 'flex' : 'none';
            });
        }
        function resetearFiltros(btn) {
            filtroCategoriaActivo = 'todas'; filtroTamanoActivo = 'todos';
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            actualizarVisibilidad();
        }
        function filtrarPorTamano(tam, btn) {
            filtroTamanoActivo = tam; filtroCategoriaActivo = 'todas';
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            actualizarVisibilidad();
        }
        function filtrarPorTexto() {
            const txt = document.getElementById('buscador-productos').value.toLowerCase();
            document.querySelectorAll('.producto-card').forEach(p => {
                p.style.display = p.getAttribute('data-nombre').includes(txt) ? 'flex' : 'none';
            });
        }
        function eliminarMesa() {
            // Pedimos confirmaci√≥n y MOTIVO
            Swal.fire({
                title: '¬øEliminar Mesa?',
                text: "Esta acci√≥n quedar√° registrada en auditor√≠a. Escribe el motivo:",
                icon: 'warning',
                input: 'text',
                inputPlaceholder: 'Ej: Cliente se retir√≥ / Error de mesero',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S√≠, Eliminar',
                cancelButtonText: 'Cancelar',
                preConfirm: (motivo) => {
                    if (!motivo) {
                        Swal.showValidationMessage('Debes escribir un motivo obligatoriamente')
                    }
                    return motivo
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const motivoIngresado = result.value;

                    // Enviamos al servidor
                    fetch("{% url 'eliminar_mesa' table.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ motivo: motivoIngresado })
                    })
                    .then(r => r.json())
                    .then(data => {
                        if(data.status === 'ok') {
                            Swal.fire('Eliminado', 'La mesa ha sido liberada.', 'success')
                            .then(() => {
                                window.location.href = "{% url 'index' %}"; // Volver al mapa de mesas
                            });
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    });
                }
            });
        }
        function pedirCuenta() {
            Swal.fire({
                title: '¬øEmitir Cuenta?',
                text: "La mesa cambiar√° a estado 'En proceso de pago' (Amarillo).",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ffc107', // Color amarillo
                confirmButtonText: 'S√≠, Imprimir Cuenta',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Abrimos el PDF en una pesta√±a nueva
                    const url = "{% url 'generar_cuenta_pdf' table.id %}";
                    window.open(url, '_blank');
                    
                    // Opcional: Recargar p√°gina o volver al mapa para ver el cambio de color
                    setTimeout(() => {
                        window.location.href = "{% url 'index' %}"; 
                    }, 1000);
                }
            });
        }

        async function iniciarFacturacion() {
        const totalTexto = document.getElementById('total-usd').innerText;
        const totalMesa = parseFloat(totalTexto);

        // Validamos que tengamos Tasa
        if (!TASA_CAMBIO || TASA_CAMBIO <= 0) {
            Swal.fire('Error', 'No hay Tasa de Cambio cargada.', 'error');
            return;
        }

        if (totalMesa <= 0) { Swal.fire('Error', 'Monto 0', 'error'); return; }

        // HTML DEL FORMULARIO MIXTO
        const htmlForm = `
            <div style="text-align: left; font-size: 0.9em;">
                <div style="margin-bottom: 15px; font-weight: bold; color: #444; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    Total a Pagar: <span style="font-size: 1.5em; color: var(--primary-blue);">$${totalMesa.toFixed(2)}</span>
                    <br>
                    <small style="color: #666; font-weight: normal;">(Bs. ${(totalMesa * TASA_CAMBIO).toLocaleString('es-VE', {minimumFractionDigits: 2})})</small>
                </div>
                
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <div class="pago-row" style="margin-bottom: 5px;">
                        <label>üíµ Efectivo (USD):</label>
                        <input type="number" id="pago-efectivo-usd" class="swal2-input" placeholder="0.00" style="margin: 0; width: 100%; height: 35px;" oninput="calcularRestante()">
                    </div>
                    <div class="pago-row">
                        <label>üè¶ Zelle (USD):</label>
                        <input type="number" id="pago-zelle" class="swal2-input" placeholder="0.00" style="margin: 0; width: 100%; height: 35px;" oninput="calcularRestante()">
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <div style="font-size: 0.8em; color: #856404; margin-bottom: 5px; text-align: right;">Tasa: Bs. ${TASA_CAMBIO.toFixed(2)}</div>
                    
                    <div class="pago-row" style="margin-bottom: 8px;">
                        <label>üì± Pago M√≥vil (Bs):</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="pago-pm" class="swal2-input" placeholder="Bol√≠vares" style="margin: 0; flex-grow: 1; height: 35px;" oninput="calcularRestante()">
                            <input type="text" id="ref-pm-usd" readonly style="width: 80px; border: none; background: transparent; color: #666; font-size: 0.9em; text-align: right;" value="$0.00">
                        </div>
                    </div>

                    <div class="pago-row" style="margin-bottom: 8px;">
                        <label>üí≥ Punto Venta (Bs):</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="pago-punto" class="swal2-input" placeholder="Bol√≠vares" style="margin: 0; flex-grow: 1; height: 35px;" oninput="calcularRestante()">
                            <input type="text" id="ref-punto-usd" readonly style="width: 80px; border: none; background: transparent; color: #666; font-size: 0.9em; text-align: right;" value="$0.00">
                        </div>
                    </div>

                    <div class="pago-row">
                        <label>üáªüá™ Efectivo (Bs):</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="pago-efectivo-bs" class="swal2-input" placeholder="Bol√≠vares" style="margin: 0; flex-grow: 1; height: 35px;" oninput="calcularRestante()">
                            <input type="text" id="ref-efec-bs-usd" readonly style="width: 80px; border: none; background: transparent; color: #666; font-size: 0.9em; text-align: right;" value="$0.00">
                        </div>
                    </div>
                </div>

                <hr style="margin: 15px 0;">
                
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
                    <span>Pagado (Equivalente):</span>
                    <span id="label-pagado" style="color: green;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
                    <span>Restante:</span>
                    <span id="label-restante" style="color: red;">$${totalMesa.toFixed(2)}</span>
                </div>
            </div>
        `;

        // ABRIR EL MODAL (CONFIGURACI√ìN DE SEGURIDAD AGREGADA)
        const { value: formValues } = await Swal.fire({
            title: 'Facturaci√≥n / Pago Mixto',
            html: htmlForm,
            focusConfirm: false,
            width: '550px',
            
            // --- AQU√ç EST√Å LA MAGIA DE SEGURIDAD ---
            allowOutsideClick: false, // Bloquea clic afuera
            allowEscapeKey: false,    // Bloquea tecla ESC
            showCloseButton: true,    // Muestra X para salir expl√≠citamente
            // ---------------------------------------

            showCancelButton: true,
            confirmButtonText: 'Procesar Pago',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                // 1. OBTENER VALORES
                const efecUsd = parseFloat(document.getElementById('pago-efectivo-usd').value) || 0;
                const zelle = parseFloat(document.getElementById('pago-zelle').value) || 0;
                
                const pmBs = parseFloat(document.getElementById('pago-pm').value) || 0;
                const puntoBs = parseFloat(document.getElementById('pago-punto').value) || 0;
                const efecBs = parseFloat(document.getElementById('pago-efectivo-bs').value) || 0;

                // 2. CONVERTIR
                const pmUsd = pmBs / TASA_CAMBIO;
                const puntoUsd = puntoBs / TASA_CAMBIO;
                const efecBsUsd = efecBs / TASA_CAMBIO;

                const totalIngresadoUsd = efecUsd + zelle + pmUsd + puntoUsd + efecBsUsd;

                // Validamos
                if (totalIngresadoUsd < (totalMesa - 0.01)) {
                    Swal.showValidationMessage(`Faltan $${(totalMesa - totalIngresadoUsd).toFixed(2)} por cobrar`);
                    return false;
                }

                // 3. CONSTRUIR LISTA
                let lista = [];
                if(efecUsd > 0) lista.push({ metodo: 'EFECTIVO_USD', monto: efecUsd });
                if(zelle > 0) lista.push({ metodo: 'ZELLE', monto: zelle });
                if(pmUsd > 0) lista.push({ metodo: 'PAGO_MOVIL', monto: pmUsd });
                if(puntoUsd > 0) lista.push({ metodo: 'PUNTO', monto: puntoUsd });
                if(efecBsUsd > 0) lista.push({ metodo: 'EFECTIVO_BS', monto: efecBsUsd });

                return {
                    lista_pagos: lista,
                    total_ingresado: totalIngresadoUsd
                };
            }
        });

        // Si el usuario le da a Cancelar o a la X, formValues es undefined y se detiene aqu√≠.
        if (!formValues) return; 

        // LOGICA DE PROPINA / VUELTO
        const diferencia = formValues.total_ingresado - totalMesa;
        let esPropina = false;

        if (diferencia > 0.01) { 
            const { isConfirmed } = await Swal.fire({
                title: `Sobra: $${diferencia.toFixed(2)}`,
                text: "¬øC√≥mo registrar el excedente?",
                icon: 'question',
                allowOutsideClick: false, // Tambi√©n bloqueamos este para seguridad
                showCancelButton: true,
                confirmButtonText: 'Es Propina üéÅ',
                cancelButtonText: 'Es Vuelto üíµ',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#3085d6'
            });
            esPropina = isConfirmed;
        }

        // ENVIAR AL BACKEND
        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        fetch("{% url 'facturar_mesa' table.id %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({
                lista_pagos: formValues.lista_pagos,
                monto_recibido_total: formValues.total_ingresado,
                es_propina: esPropina
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'ok') {
                Swal.fire('¬°√âxito!', 'Factura generada', 'success').then(() => {
                    window.open(`/factura/${data.venta_id}/pdf/`, '_blank');
                    window.location.href = "{% url 'index' %}";
                });
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        });
    }

    // FUNCI√ìN AUXILIAR DE C√ÅLCULO EN TIEMPO REAL
    window.calcularRestante = function() {
        const total = parseFloat(document.getElementById('total-usd').innerText);
        
        // Entradas en USD
        const efecUsd = parseFloat(document.getElementById('pago-efectivo-usd').value) || 0;
        const zelle = parseFloat(document.getElementById('pago-zelle').value) || 0;
        
        // Entradas en Bs
        const pmBs = parseFloat(document.getElementById('pago-pm').value) || 0;
        const puntoBs = parseFloat(document.getElementById('pago-punto').value) || 0;
        const efecBs = parseFloat(document.getElementById('pago-efectivo-bs').value) || 0;

        // Conversi√≥n Visual
        const pmUsd = pmBs / TASA_CAMBIO;
        const puntoUsd = puntoBs / TASA_CAMBIO;
        const efecBsUsd = efecBs / TASA_CAMBIO;

        // Actualizamos los textos peque√±os de referencia
        document.getElementById('ref-pm-usd').value = `$${pmUsd.toFixed(2)}`;
        document.getElementById('ref-punto-usd').value = `$${puntoUsd.toFixed(2)}`;
        document.getElementById('ref-efec-bs-usd').value = `$${efecBsUsd.toFixed(2)}`;

        // Suma Total en USD
        const totalPagado = efecUsd + zelle + pmUsd + puntoUsd + efecBsUsd;
        const restante = total - totalPagado;

        document.getElementById('label-pagado').innerText = `$${totalPagado.toFixed(2)}`;
        
        const elRestante = document.getElementById('label-restante');
        
        // Tolerancia peque√±a para errores de punto flotante
        if (restante > 0.009) {
            elRestante.innerText = `$${restante.toFixed(2)}`;
            elRestante.style.color = 'red';
            elRestante.innerText += " (Falta)";
        } else {
            elRestante.innerText = `$${Math.abs(restante).toFixed(2)}`;
            elRestante.style.color = 'green';
            elRestante.innerText += " (Sobra)";
        }
    }
    </script>
</body>
</html>