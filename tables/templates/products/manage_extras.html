{% extends 'base.html' %}
{% load tables_extras %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Matriz de Extras</h2>
            <p class="text-secondary m-0">Configura Precios y Porciones (Peso) por tamaño.</p>
        </div>
        <a href="{% url 'product_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <div class="card border-0 shadow-sm rounded-3">
            <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Configuración de Extras</h5>
                <button type="submit" class="btn btn-light btn-sm fw-bold text-primary shadow-sm">
                    <i class="bi bi-save me-1"></i> Guardar Todo
                </button>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 75vh;">
                    <table class="table table-bordered align-middle mb-0 text-center">
                        <thead class="bg-light sticky-top shadow-sm" style="z-index: 10;">
                            <tr>
                                <th class="text-start ps-4 py-3" style="width: 25%;">Insumo</th>
                                {% for tam in tamanos %}
                                    <th class="py-3" style="min-width: 140px;">
                                        <div class="fw-bold">{{ tam }}</div>
                                        <div class="small fw-normal text-muted">Precio | Peso</div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for insumo in insumos %}
                            <tr>
                                <td class="text-start ps-4 fw-medium bg-white">
                                    <div class="text-dark">{{ insumo.nombre }}</div>
                                    <div class="badge bg-secondary bg-opacity-10 text-secondary border mt-1">
                                        {{ insumo.unidad }}
                                    </div>
                                </td>

                                {% for tam in tamanos %}
                                    <td class="p-2" style="background-color: #f8f9fa;">
                                        
                                        {% with precio_key="precio_"|add:insumo.id_str|add:"_"|add:tam cantidad_key="cantidad_"|add:insumo.id_str|add:"_"|add:tam %}
                                        
                                        <div class="input-group input-group-sm mb-1">
                                            <span class="input-group-text bg-success bg-opacity-10 text-success border-success border-opacity-25 fw-bold">$</span>
                                            
                                            <input type="number" step="0.01" min="0"
                                                   class="form-control fw-bold text-success border-success border-opacity-25"
                                                   name="precio_{{ insumo.id }}_{{ tam }}" 
                                                   value="{{ datos|get_item:precio_key|default:'' }}"
                                                   placeholder="0.00">
                                        </div>

                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-primary bg-opacity-10 text-primary border-primary border-opacity-25">
                                                <i class="bi bi-basket2-fill" style="font-size: 0.8em;"></i>
                                            </span>
                                            
                                            <input type="number" step="0.0001" min="0"
                                                   class="form-control text-primary border-primary border-opacity-25"
                                                   name="cantidad_{{ insumo.id }}_{{ tam }}"
                                                   value="{{ datos|get_item:cantidad_key|default:''|floatformat:0 }}"
                                                   placeholder="Peso">
                                        </div>
                                        
                                        {% endwith %}

                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* Estilos visuales */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; margin: 0; 
    }
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }
</style>
{% endblock %}