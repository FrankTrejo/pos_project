{% extends 'base.html' %}
{% block title %}- Receta {{ insumo.nombre }}{% endblock %}

{% block content %}

<style>
    .composition-form {
        background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 25px;
        display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;
    }
    .composition-form input, .composition-form select {
        width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 5px; height: 40px; box-sizing: border-box;
    }
    .btn-add-ingredient {
        height: 40px; width: 50px; background-color: #343a40; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .field-group { display: flex; flex-direction: column; }
    .field-grow { flex-grow: 1; min-width: 200px; }
    .field-fixed { width: 150px; }
</style>

<div style="max-width: 900px; margin: 40px auto; padding: 20px;">
    
    <div style="margin-bottom: 30px; text-align: center;">
        <h2 style="color: #0d6efd; margin: 0;">Composición: {{ insumo.nombre }}</h2>
        <p style="color: #666; margin-top: 10px;">
            Define la receta para fabricar <b>{{ total_cantidad|floatformat:0 }} {{ insumo.unidad.codigo }}</b> de este insumo.
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 25px;">
        
        <div class="card-style" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; height: fit-content; text-align: center;">
            <h3 style="margin-top: 0; color: #444;">Costo Calculado</h3>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            
            <div style="font-size: 2.2em; font-weight: bold; color: #28a745; margin: 15px 0;">
                ${{ insumo.costo_unitario|floatformat:4 }}
            </div>
            
            <div style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                Costo por cada {{ total_cantidad|floatformat:0 }} {{ insumo.unidad.nombre }}
            </div>

            <a href="{% url 'inventory_index' %}" class="add-btn" style="display: block; text-decoration: none; background: #343a40; color: white; padding: 10px; border-radius: 5px;">
                <i class="fas fa-check"></i> Finalizar y Volver
            </a>
        </div>

        <div class="card-style" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #444;">Ingredientes / Sub-insumos</h3>
            
            <form method="POST" class="composition-form">
                {% csrf_token %}
                <div class="field-group field-grow">
                    <label style="font-weight: bold; margin-bottom: 5px; font-size: 0.9em;">Ingrediente (Hijo):</label>
                    {{ form.insumo_hijo }}
                </div>
                <div class="field-group field-fixed">
                    <label style="font-weight: bold; margin-bottom: 5px; font-size: 0.9em;">Cant. ({{ insumo.unidad.codigo }}):</label>
                    {{ form.cantidad }}
                </div>
                <div class="field-group">
                    <button type="submit" class="btn-add-ingredient" title="Agregar Ingrediente"><i class="fas fa-plus"></i></button>
                </div>
            </form>

            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr style="border-bottom: 2px solid #eee; text-align: left; color: #666; font-size: 0.9em;">
                        <th style="padding: 10px;">Insumo</th>
                        <th style="padding: 10px;">Cantidad</th>
                        <th style="padding: 10px;">Costo Aprox.</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for comp in componentes %}
                    <tr style="border-bottom: 1px solid #f9f9f9;">
                        <td style="padding: 10px; font-weight: bold;">{{ comp.insumo_hijo.nombre }}</td>
                        <td style="padding: 10px;">
                            {{ comp.cantidad|floatformat:0  }} {{ comp.insumo_hijo.unidad.codigo|floatformat:0 }}
                        </td>
                        <td style="padding: 10px; color: #666;">
                            ${{ comp.costo_fila|floatformat:4 }}
                        </td>
                        <td style="padding: 10px; text-align: right;">
                            <form method="POST" onsubmit="return confirm('¿Eliminar?');">
                                {% csrf_token %}
                                <input type="hidden" name="delete_componente" value="{{ comp.id }}">
                                <button type="submit" style="background: none; border: none; color: #dc3545; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="padding: 30px; text-align: center; color: #999;">Sin ingredientes.</td></tr>
                    {% endfor %}
                </tbody>
                
                {% if componentes %}
                <tfoot>
                    <tr style="background-color: #f1f8ff; border-top: 2px solid #0d6efd;">
                        <td style="padding: 15px 10px; font-weight: bold; color: #0d6efd;">TOTAL MEZCLA:</td>
                        <td style="padding: 15px 10px; font-weight: bold; color: #333;">
                            {{ total_cantidad|floatformat:0  }} {{ insumo.unidad.codigo }}
                        </td>
                        <td colspan="2" style="padding: 15px 10px; color: #666; font-size: 0.9em;">
                            <i>{{ insumo.costo_unitario|floatformat:4 }}</i>
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>
{% endblock %}