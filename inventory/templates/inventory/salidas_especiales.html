{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding: 20px;">
    <h2><i class="fas fa-hand-holding-heart"></i> Consumo Interno y Salidas</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        
        <div class="card-style" style="padding: 20px;">
            <h3 style="color: var(--primary-blue);">üë®‚Äçüç≥ Comida de Personal</h3>
            <p style="font-size: 0.9em; color: #666;">Selecciona el tama√±o base y agrega los extras exactos.</p>
            
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo_accion" value="PERSONAL">
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: bold; font-size: 0.9em;">Empleado:</label>
                        <input type="text" name="empleado_nombre" class="form-control" placeholder="Nombre..." required style="width: 100%;">
                    </div>
                    <div>
                        <label style="font-weight: bold; font-size: 0.9em;">Tama√±o Base:</label>
                        <select name="tamano_pizza" class="form-control" style="width: 100%;" required>
                            <option value="IND">Individual</option>
                            <option value="MED">Mediana</option>
                            <option value="FAM">Familiar</option>
                        </select>
                    </div>
                </div>

                <label style="font-weight: bold; font-size: 0.9em;">Ingredientes Extra (Opcional):</label>
                
                <input type="text" id="buscador-ingredientes" placeholder="üîç Buscar ingrediente..." 
                       style="width: 100%; padding: 6px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px;"
                       onkeyup="filtrarIngredientes()">

                <div id="lista-ingredientes" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; background: #fff;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead style="background: #f1f1f1; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 5px; text-align: left;">Insumo</th>
                                <th style="padding: 5px; text-align: right;">Cant. Extra</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ing in ingredientes %}
                            <tr class="item-ingrediente" style="border-bottom: 1px solid #eee;">
                                <td style="padding: 5px;">
                                    {{ ing.nombre }} <small style="color: #888;">({{ ing.unidad.codigo }})</small>
                                </td>
                                <td style="padding: 5px; text-align: right;">
                                    <input type="hidden" name="extra_id" value="{{ ing.id }}">
                                    <input type="number" name="extra_cantidad" class="input-cantidad" 
                                           placeholder="0" step="0.01" min="0"
                                           style="width: 70px; text-align: right; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2" style="padding: 10px; text-align: center;">No hay insumos disponibles.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div style="background: #e8f5e9; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.85em; color: #2e7d32;">
                    <i class="fas fa-info-circle"></i> Se descontar√° autom√°ticamente la receta de la <b>Margarita</b> del tama√±o seleccionado + los extras que indiques aqu√≠.
                </div>

                <button type="submit" class="action-btn" style="width: 100%; margin-top: 15px;">Registrar Consumo</button>
            </form>
        </div>

        <div class="card-style" style="padding: 20px;">
            <h3 style="color: #e67e22;">üéÅ Cortes√≠a de la Casa</h3>
            <p style="font-size: 0.9em; color: #666;">Descuenta la receta completa del producto.</p>
            
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="tipo_accion" value="REGALO">
                
                <label>Seleccionar Producto:</label>
                <select name="producto_regalo" class="form-control" style="width: 100%; margin-bottom: 10px;" required>
                    {% for prod in productos %}
                        <option value="{{ prod.id }}">{{ prod.nombre }}</option>
                    {% endfor %}
                </select>

                <label>Motivo / Destinatario:</label>
                <input type="text" name="nota" class="form-control" placeholder="Ej: Mesa 4, Amigo del due√±o..." required style="width: 100%; margin-bottom: 15px;">

                <button type="submit" class="action-btn" style="width: 100%; background-color: #e67e22;">Registrar Regalo</button>
            </form>
        </div>

    </div>
        <div style="margin-top: 40px;">
            <h3 style="color: #444; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                <i class="fas fa-history"></i> Historial Reciente
            </h3>

            <div class="card-style" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa; color: #444;">
                        <tr>
                            <th style="padding: 12px; text-align: left;">Fecha</th>
                            <th style="padding: 12px; text-align: left;">Tipo</th>
                            <th style="padding: 12px; text-align: left;">Responsable</th>
                            <th style="padding: 12px; text-align: left;">Descripci√≥n</th>
                            <th style="padding: 12px; text-align: right;">Costo Est.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historial %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">{{ item.fecha|date:"d/m/Y H:i" }}</td>
                            
                            <td style="padding: 10px;">
                                {% if item.tipo == 'PERSONAL' %}
                                    <span style="background: #d1ecf1; color: #0c5460; padding: 3px 8px; border-radius: 10px; font-size: 0.85em;">Personal</span>
                                {% elif item.tipo == 'CORTESIA' %}
                                    <span style="background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 10px; font-size: 0.85em;">Cortes√≠a</span>
                                {% else %}
                                    <span style="background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 10px; font-size: 0.85em;">Merma</span>
                                {% endif %}
                            </td>

                            <td style="padding: 10px;">{{ item.usuario.username|title }}</td>
                            <td style="padding: 10px;">{{ item.descripcion }}</td>
                            <td style="padding: 10px; text-align: right; color: #d63031;">-${{ item.costo_estimado }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="padding: 20px; text-align: center; color: #999;">
                                No hay registros recientes.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    window.addEventListener('load', function() {
        // 1. Buscamos si hay una orden de impresi√≥n
        const urlParams = new URLSearchParams(window.location.search);
        const printId = urlParams.get('print_id');

        if (printId) {
            // 2. Limpiamos la URL para que no moleste al recargar
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // 3. Construimos la ruta del PDF
            const urlPdf = `/inventory/comanda-interna/${printId}/pdf/`;

            // 4. ALERTA CL√ÅSICA (IGUAL A FACTURACI√ìN)
            Swal.fire({
                title: '¬°Consumo Registrado!',
                text: "La comanda de cocina se gener√≥ correctamente.",
                icon: 'success',
                showCancelButton: true,
                confirmButtonColor: '#3085d6', // Azul
                cancelButtonColor: '#d33',    // Rojo
                confirmButtonText: 'üìÑ Abrir Comanda',
                cancelButtonText: 'Cerrar'
            }).then((result) => {
                // 5. SI EL USUARIO HACE CLIC EN "ABRIR", LANZAMOS EL PDF
                if (result.isConfirmed) {
                    window.open(urlPdf, '_blank');
                }
            });
        }
    });
</script>
{% endblock %}